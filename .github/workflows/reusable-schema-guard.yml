name: Reusable – Schema Guard

on:
  workflow_call:
    inputs:
      include:
        description: "Glob patterns"
        required: true
        type: string
      exclude:
        description: "Exclusive glob patterns"
        required: false
        type: string
        default: ""
      annotate:
        description: "PR-comment on error"
        required: false
        type: boolean
        default: true
  workflow_dispatch:       # ← Manual start
    inputs:
      include:
        description: "Glob patterns"
        required: true
        default: |
          schemas/**
          ecosystems/**
      exclude:
        description: "Exclusive glob patterns"
        required: false
        default: ""
      annotate:
        description: "PR-comment on manual dispatch."
        required: false
        type: boolean
        default: true        

jobs:
  schema-guard:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          if [ -z "${{ inputs.include }}" ]; then
            echo "Missing required 'include' patterns."
            exit 2
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Echo inputs (informative)
        shell: bash
        run: |
          set -euo pipefail
          echo "Included globs (info):"
          printf '%s\n' "${{ inputs.include }}"
          echo "Excluded globs (info):"
          printf '%s\n' "${{ inputs.exclude }}"

      - name: Run schema validation
        id: validate
        shell: bash
        run: |
          set -o pipefail

          npm run -s validate-schemas | tee schema-guard.log
          status=${PIPESTATUS[0]}

          if [ ! -s schema-guard.log ]; then
            echo "validate-schemas did not produce output (possible quoting/indent issue)" > schema-guard.log
          fi

          echo "status=$status" >> "$GITHUB_OUTPUT"

      - name: Upload schema-guard log (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-guard-log
          path: schema-guard.log
          if-no-files-found: warn
          retention-days: 7

      - name: Annotate PR with failure summary
        if: ${{ steps.validate.outputs.status != '0' && inputs.annotate && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('schema-guard.log', 'utf8');
            // cut the log to 200 lines at the end
            const tail = log.split('\n').slice(-200).join('\n');
            const body = [
              '### ❌ Schema validation failed',
              '',
              '**Tail of `schema-guard.log` (last ~200 lines):**',
              '',
              '```text',
              tail,
              '```',
              '',
              '_Workflow: Reusable – Schema Guard_'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Fail if validation failed
        if: ${{ steps.validate.outputs.status != '0' }}
        run: |
          echo "Schema validation failed with status=${{ steps.validate.outputs.status }}"
          exit 1
