name: Reusable Schema Guard

on:
  workflow_call:
    inputs:
      paths:
        description: 'Comma-separated glob patterns for files to validate'
        required: true
        type: string
      exclude:
        description: 'Comma- or newline-separated glob patterns to exclude'
        required: false
        default: ''
        type: string
      annotate:
        description: 'Emit GitHub error annotations for failing files'
        required: false
        default: false
        type: boolean        
    secrets:
      ORG_READ_TOKEN:
        description: 'Fine-grained PAT with Contents: Read for the zkpip/zkpip repo'
        required: true

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4

      - name: Checkout core schema repository
        uses: actions/checkout@v4
        with:
          repository: zkpip/zkpip
          ref: ${{ github.ref }} # same tag/branch as the consumer repo
          token: ${{ secrets.ORG_READ_TOKEN }}
          path: __core

      - name: Build core validator
        run: |
          npm ci --prefix __core
          npm run build --prefix __core/packages/core

      # Collect matching files using shell (no npm install in the consumer repo)
      - name: Collect matching files
        id: collect
        shell: bash
        env:
          GLOBS: ${{ inputs.paths }}
          EXCLUDES: ${{ inputs.exclude }}
        run: |
          set -euo pipefail
          # Convert comma-separated globs into an array
          mapfile -t patterns < <(printf "%s" "$GLOBS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          files=()
          for pat in "${patterns[@]}"; do
            # Use git ls-files to match tracked files only
            while IFS= read -r f; do
              [[ -n "$f" ]] && files+=("$f")
            done < <(git ls-files "$pat" 2>/dev/null || true)
          done
          # Remove duplicates and sort
          printf "%s\n" "${files[@]}" | awk 'NF' | sort -u > .schema_files.txt
          
          if [[ -n "${EXCLUDES// /}" ]]; then
            mapfile -t xpat < <(printf "%s" "$EXCLUDES" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | awk 'NF')
            > .schema_excludes.txt
            for pat in "${xpat[@]}"; do
              git ls-files "$pat" 2>/dev/null || true
            done | awk 'NF' | sort -u > .schema_excludes.txt
            grep -Fvx -f .schema_excludes.txt .schema_includes.txt || true > .schema_files.txt
          else
            cp .schema_includes.txt .schema_files.txt
          fi          
          echo "Collected files for schema validation:"
          cat .schema_files.txt || true
          # Export for the next step
          {
            echo 'FILES<<EOF'
            cat .schema_files.txt
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Run schema validation
        shell: bash
        env:
          ANNOTATE: ${{ inputs.annotate }}        
        run: |
          node -e "
            const { validateFileBatch } = require('./__core/packages/core/dist/cli/validate.js');
            const files = (process.env.FILES || '').split('\n').filter(Boolean);
            (async () => {
              if (!files.length) {
                console.log('No files matched');
                process.exit(0);
              }
              const { failed } = await validateFileBatch(files);
              if (failed.length) {
                if (process.env.ANNOTATE === 'true') {
                  for (const f of failed) {
                    const file = typeof f === 'string' ? f : (f.file || f.path || '');
                    const msg = (typeof f === 'object' && f.message) ? f.message : 'Schema validation failed';
                    if (file) console.log('::error file=' + file + '::' + msg);
                    else console.log('::error::' + msg);
                  }
                }              
                console.error('Invalid files:', failed);
                process.exit(1);
              }
              console.log('All files are schema-valid âœ…');
            })().catch(e => { console.error(e); process.exit(1); });
          "