name: Reusable Schema Guard

on:
  workflow_call:
    inputs:
      paths:
        description: 'Comma-separated glob patterns for files to validate'
        required: true
        type: string
    secrets:
      ORG_READ_TOKEN:
        description: 'Fine-grained PAT with Contents: Read for the zkpip/zkpip repo'
        required: true

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4

      - name: Checkout core schema repository
        uses: actions/checkout@v4
        with:
          repository: zkpip/zkpip
          ref: ${{ github.ref }} # same tag/branch as the consumer repo
          token: ${{ secrets.ORG_READ_TOKEN }}
          path: __core

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build core validator
        run: |
          npm ci --prefix __core
          npm run build --prefix __core/packages/core

      # Collect matching files using shell (no npm install in the consumer repo)
      - name: Collect matching files
        id: collect
        shell: bash
        env:
          GLOBS: ${{ inputs.paths }}
        run: |
          set -euo pipefail
          # Convert comma-separated globs into an array
          mapfile -t patterns < <(printf "%s" "$GLOBS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          files=()
          for pat in "${patterns[@]}"; do
            # Use git ls-files to match tracked files only
            while IFS= read -r f; do
              [[ -n "$f" ]] && files+=("$f")
            done < <(git ls-files "$pat" 2>/dev/null || true)
          done
          # Remove duplicates and sort
          printf "%s\n" "${files[@]}" | awk 'NF' | sort -u > .schema_files.txt
          echo "Collected files for schema validation:"
          cat .schema_files.txt || true
          # Export for the next step
          {
            echo 'FILES<<EOF'
            cat .schema_files.txt
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Run schema validation
        shell: bash
        run: |
          node -e "
            const { validateFileBatch } = require('./__core/packages/core/dist/cli/validate.js');
            const files = (process.env.FILES || '').split('\n').filter(Boolean);
            (async () => {
              if (!files.length) {
                console.log('No files matched');
                process.exit(0);
              }
              const { failed } = await validateFileBatch(files);
              if (failed.length) {
                console.error('Invalid files:', failed);
                process.exit(1);
              }
              console.log('All files are schema-valid âœ…');
            })().catch(e => { console.error(e); process.exit(1); });
          "