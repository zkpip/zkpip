name: Reusable Schema Guard

on:
  workflow_call:
    inputs:
      paths:
        required: true
        type: string
    secrets:
      ORG_READ_TOKEN:
        required: true

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout consumer repo
        uses: actions/checkout@v4

      - name: Checkout core schema repo
        uses: actions/checkout@v4
        with:
          repository: zkpip/zkpip
          ref: ${{ github.ref }}
          token: ${{ secrets.ORG_READ_TOKEN }}
          path: __core

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Build core validator
        run: |
          npm ci --prefix __core
          npm run build --prefix __core/packages/core

      - name: Ensure fast-glob is available in consumer workspace
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm i -D fast-glob@^3.3.2
          
      - name: Run schema validation
        run: |
          node -e "const fg=require('fast-glob');
          const { validateFileBatch } = require('./__core/packages/core/dist/cli/validate.js');
          (async()=>{
            const globs=(process.env.GLOBS||'').split(',').map(s=>s.trim()).filter(Boolean);
            const files=await fg(globs,{dot:false,onlyFiles:true});
            if(!files.length){ console.log('No files matched'); process.exit(0); }
            const {failed}=await validateFileBatch(files);
            if(failed.length){ console.error('Invalid files:', failed); process.exit(1); }
            console.log('All files are schema-valid âœ…');
          })().catch(e=>{ console.error(e); process.exit(1); });"
        env:
          GLOBS: ${{ inputs.paths }}
