name: cli-smoke-plonk

on:
  push:
    branches: [ feat/cli-esm-verify-refactor ]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke-plonk:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [20, 22]    # lokálisan 22-vel ment; itt lefuttatjuk 20 és 22 alatt is
    name: PLONK smoke (Node ${{ matrix.node }})

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - run: npm ci

      - name: Clean dists
        run: npx rimraf packages/**/dist packages/**/tsconfig.tsbuildinfo

      # Ha a PLONK vektorok commitolva vannak, NEM kell generálni őket.
      # (Ha mégsem lennének, kommentben hagytam egy opcionális lépést lejjebb.)

      - name: Build CLI
        run: npm -w @zkpip/cli run build

      - name: Smoke script (valid→0, invalid→1, broken json→2)
        run: npm -w @zkpip/cli run smoke:plonk

      - name: Vitest smoke (opcionális, ha felvetted)
        run: |
          if npm -w @zkpip/cli run | grep -q "test:smoke:plonk"; then
            npm -w @zkpip/cli run test:smoke:plonk
          else
            echo "No vitest smoke script found, skipping."
          fi

      # --- Optional fallback: if the PLONK vectors directory is NOT committed, generate it.
      # WARNING: this requires the circom + snarkjs toolchain on the runner and will slow down CI.
      # - name: Generate PLONK vectors (fallback)
      #   # Note: GitHub Actions doesn't have an `exists()` function. Use hashFiles instead:
      #   # if: ${{ hashFiles('packages/core/schemas/tests/vectors/mvs/verification/snarkjs-plonk/valid/verification_key.json') == '' }}
      #   # If you still want to keep the intent visible, you can leave the line below as a comment:
      #   # if: ${{ !exists('packages/core/schemas/tests/vectors/mvs/verification/snarkjs-plonk/valid/verification_key.json') }}
      #   run: npm -w @zkpip/cli run vectors:plonk:gen          