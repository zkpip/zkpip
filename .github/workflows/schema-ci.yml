name: Schema & Core CI

on:
  pull_request:
    paths:
      - '**/*.ts'
      - 'schemas/**'
      - '.github/workflows/**'
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [18, 20]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
      - name: Install dependencies (prefer npm ci)
        run: |
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi
      - name: Run lint (fail on error)
        run: npm run -w @zkpip/core lint

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [18, 20]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
      - name: Install dependencies (prefer npm ci)
        run: |
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi
      - name: Run typecheck
        run: npm run -w @zkpip/core typecheck

  build:
    name: build
    runs-on: ubuntu-latest
    needs: [typecheck]
    strategy:
      matrix:
        node: [18, 20]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
      - name: Install dependencies (prefer npm ci)
        run: |
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi
      - name: Build core package
        run: npm run -w @zkpip/core build
      - name: Sanity check build output (non-blocking)
        run: |
          if [ -f packages/core/dist/validation/ajv.js ]; then
            echo "✅ ajv.js found in build output."
          else
            echo "⚠️ ajv.js is missing in dist/validation (non-blocking for now)."
          fi

  test:
    name: test
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      matrix:
        node: [18, 20]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
      - name: Install dependencies (prefer npm ci)
        run: |
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi
      - name: Run tests (fail on error)
        run: npm test -w @zkpip/core

  # Reusable workflow call MUST be at job-level (uses/with/secrets)
  schema_guard:
    name: schema-guard (reusable)
    needs: [build]
    permissions:
      contents: read
      pull-requests: read
    uses: zkpip/zkpip/.github/workflows/reusable-schema-guard.yml@v0.1.12
    with:
      paths: "schemas/**/*.json, output/**/*.json"
      exclude: "node_modules/**, **/dist/**, **/build/**"
      annotate: true
      core_ref: ""
    secrets:
      ORG_READ_TOKEN: ${{ secrets.ORG_READ_TOKEN }} 
