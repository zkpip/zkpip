name: CI (minimal)

on:
  pull_request:
  push:
    branches: [ main, feat/**, chore/**, fix/** ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install (workspaces)
        run: npm install --workspaces

      - name: Build core
        run: npm -w @zkpip/core run build

      - name: Build cli
        run: npm -w @zkpip/cli run build

  smoke:
    runs-on: ubuntu-latest
    needs: build
    env:
      ZKPIP_LOCALE: en
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install (workspaces)
        run: npm install --workspaces

      - name: Build core
        run: npm -w @zkpip/core run build

      - name: Build cli
        run: npm -w @zkpip/cli run build

      - name: List adapters
        run: node packages/cli/dist/index.js adapters --json

      - name: Prepare CI-inline bundle
        run: |
            VALID="packages/core/schemas/tests/vectors/mvs/verification/snarkjs-groth16/valid/proof-bundle.valid.json"
            OUT="${VALID%.json}.ci.valid.json"
            node packages/core/scripts/make-ci-bundle.mjs "$VALID" "$OUT"
            echo "CI_BUNDLE=$OUT" >> $GITHUB_ENV

      - name: Verify valid vector (expect exit 0)
        run: |
            node packages/cli/dist/index.js verify \
            --no-schema \
            --bundle "$CI_BUNDLE" \
            --adapter snarkjs-groth16 \
            --json \
            --use-exit-codes

      - name: Verify all invalid vectors (expect exit 1 for each)
        run: |
            ROOT="packages/core/schemas/tests/vectors/mvs/verification/snarkjs-groth16/invalid"
            FAILS=0
            for f in $(find "$ROOT" -type f -name '*.json' | sort); do
            OUT="${f%.json}.ci.invalid.json"
            node packages/core/scripts/make-ci-bundle.mjs "$f" "$OUT"
            set +e
            node packages/cli/dist/index.js verify \
                --no-schema \
                --bundle "$OUT" \
                --adapter snarkjs-groth16 \
                --json \
                --use-exit-codes
            CODE=$?
            if [ "$CODE" -ne 1 ]; then
                echo "::error title=Invalid vector verified unexpectedly::${f} returned $CODE"
                FAILS=$((FAILS+1))
            fi
            done
            if [ "$FAILS" -ne 0 ]; then
            echo "$FAILS invalid case(s) did not fail verification"
            exit 1
            fi