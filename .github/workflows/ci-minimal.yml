name: CI (minimal)

on:
  pull_request:
  push:
    branches: [ main, feat/**, chore/**, fix/** ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install (workspaces)
        run: npm install --workspaces

      - name: Build core
        run: npm -w @zkpip/core run build

      - name: Build cli
        run: npm -w @zkpip/cli run build

  smoke:
    runs-on: ubuntu-latest
    needs: build
    env:
      ZKPIP_LOCALE: en
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install (workspaces)
        run: npm install --workspaces

      - name: Build core
        run: npm -w @zkpip/core run build

      - name: Build cli
        run: npm -w @zkpip/cli run build

      - name: List adapters
        run: node packages/cli/dist/index.js adapters --json

      - name: Verify valid vector (expect exit 0)
        run: |
          VALID="packages/core/schemas/tests/vectors/mvs/verification/snarkjs-groth16/valid/proof-bundle.valid.json"
          node packages/cli/dist/index.js verify \
            --bundle "$VALID" \
            --adapter snarkjs-groth16 \
            --json \
            --use-exit-codes

      - name: Verify one invalid vector (expect exit 1)
        run: |
          INVALID=$(ls packages/core/schemas/tests/vectors/mvs/verification/snarkjs-groth16/invalid/*.json | head -n1)
          set +e
          node packages/cli/dist/index.js verify \
            --bundle "$INVALID" \
            --adapter snarkjs-groth16 \
            --json \
            --use-exit-codes
          CODE=$?
          if [ "$CODE" -ne 1 ]; then
            echo "Expected exit code 1 for invalid vector, got $CODE"
            exit 1
          fi
