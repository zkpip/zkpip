name: Core & CLI CI

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: core-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changed areas
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      cli: ${{ steps.filter.outputs.cli }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'packages/core/**'
              - 'package.json'
              - 'package-lock.json'
              - 'npm-shrinkwrap.json'
            cli:
              - 'packages/cli/**'
              - 'package.json'
              - 'package-lock.json'
              - 'npm-shrinkwrap.json'

  lint:
    name: Lint & format check
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.cli == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: .
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install (root)
        run: npm ci --no-audit --fund=false

      - name: Show npm scripts (debug)
        run: node -e "console.log(require('./package.json').scripts)"

      - name: ESLint (flat, workspaces)
        run: npm run -ws lint
        env:
          ESLINT_USE_FLAT_CONFIG: 'true'

      - name: Prettier check (workspaces)
        run: npm run -ws format:check

  core:
    name: Core build & test
    needs: changes
    if: needs.changes.outputs.core == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: packages/core

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      # Monorepo install (root)
      - name: Install (root)
        working-directory: .
        run: npm ci --no-audit --fund=false

      - name: TypeScript typecheck (non-blocking)
        run: npm run -s typecheck || npx tsc -p tsconfig.json --noEmit || echo "Typecheck warnings ignored"

      - name: Run tests with coverage (Vitest)
        run: npm run -s test:coverage || npm run -s test -- --coverage

      - name: Assert LCOV exists
        if: always()
        run: test -f coverage/lcov.info || (echo "‚ùå lcov.info missing"; ls -lah coverage || true; exit 1)

      - name: Upload coverage (LCOV)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-coverage
          path: packages/core/coverage/
          if-no-files-found: error

  cli-integration:
    name: CLI integration (Node ${{ matrix.node }})
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.cli == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        node: [20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install (root)
        run: npm ci --no-audit --fund=false

      - name: Build core (ESM dist must exist)
        run: npm --prefix packages/core run build

      - name: Build CLI (ESM dist for runtime smoke)
        run: npm --prefix packages/cli run build

      - name: Run CLI tests (Vitest)
        run: npm --prefix packages/cli run test

      - name: Smoke vectors validate (explicit schemas-root)
        run: |
          node packages/cli/dist/index.js vectors validate \
            --vectors-root ./packages/core/schemas/tests/vectors/mvs/verification \
            --schemas-root ./packages/core/schemas

      - name: Smoke top-level validate single file
        run: |
          node packages/cli/dist/index.js validate \
            ./packages/core/schemas/tests/vectors/mvs/verification/proofBundle/proof-bundle.valid.json \
            --schemas-root ./packages/core/schemas

      - name: CLI e2e
        run: npm --prefix packages/cli run e2e            
