name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true

jobs:
  # 1) Prettier + ESLint + Typecheck az egész monorepóra
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Prettier check
        run: npm run format:check

      - name: Typecheck (tsc -b)
        run: npx tsc -b --pretty false

      - name: ESLint
        run: npm run lint

  # 2) CLI build + vitest + E2E smoke (PLONK + ZoKrates) több Node verzióval
  cli-test:
    needs: [checks]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [18, 20, 22]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Changed paths filter
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            cli:
              - 'packages/cli/**'
              - 'packages/*/src/**'
              - 'packages/*/tsconfig.json'
              - 'package.json'
              - 'package-lock.json'
              - 'pnpm-lock.yaml'
              - 'fixtures/**'

      - uses: actions/setup-node@v4
        if: steps.changes.outputs.cli == 'true'
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Install deps
        if: steps.changes.outputs.cli == 'true'
        run: npm ci

      - name: Print versions
        if: steps.changes.outputs.cli == 'true'
        run: |
          node -v
          npm -v

      - name: Build CLI
        if: steps.changes.outputs.cli == 'true'
        run: npm -w @zkpip/cli run build

      - name: Run unit+integration tests (vitest)
        if: steps.changes.outputs.cli == 'true'
        run: npm -w @zkpip/cli run test

      - name: E2E smoke — PLONK (exit code contract)
        if: steps.changes.outputs.cli == 'true'
        shell: bash
        run: |
          set -euo pipefail
          CLI="packages/cli/dist/index.js"

          # Adapters list must succeed
          node "$CLI" adapters --json >/dev/null

          # Valid -> 0
          node "$CLI" verify \
            --adapter snarkjs-plonk \
            --verification fixtures/snarkjs-plonk/valid/verification.json \
            --json --use-exit-codes >/dev/null

          # Invalid -> 1
          set +e
          node "$CLI" verify \
            --adapter snarkjs-plonk \
            --verification fixtures/snarkjs-plonk/invalid/verification.json \
            --json --use-exit-codes 1>/dev/null
          code=$?; set -e
          if [ "$code" -ne 1 ]; then
            echo "Expected exit 1 (PLONK invalid), got $code"; exit 1; fi

          # ENOENT -> 2
          set +e
          node "$CLI" verify --adapter snarkjs-plonk \
            --verification definitely-does-not-exist.json \
            --json --use-exit-codes 1>/dev/null
          code=$?; set -e
          if [ "$code" -ne 2 ]; then
            echo "Expected exit 2 (ENOENT), got $code"; exit 1; fi

          # Schema invalid quick -> 3
          set +e
          node "$CLI" verify --adapter snarkjs-plonk \
            --verification '{"proof":""}' \
            --json --use-exit-codes 1>/dev/null
          code=$?; set -e
          if [ "$code" -ne 3 ]; then
            echo "Expected exit 3 (schema invalid), got $code"; exit 1; fi

          # Adapter not found -> 4
          set +e
          node "$CLI" verify --adapter not-a-real-adapter \
            --verification fixtures/snarkjs-plonk/valid/verification.json \
            --json --use-exit-codes 1>/dev/null
          code=$?; set -e
          if [ "$code" -ne 4 ]; then
            echo "Expected exit 4 (adapter not found), got $code"; exit 1; fi

      - name: E2E smoke — ZoKrates (exit code contract)
        if: steps.changes.outputs.cli == 'true'
        shell: bash
        run: |
          set -euo pipefail
          CLI="packages/cli/dist/index.js"

          # Valid -> 0
          node "$CLI" verify \
            --adapter zokrates-groth16 \
            --verification fixtures/zokrates-groth16/valid/verification.json \
            --json --use-exit-codes >/dev/null

          # Invalid -> 1
          set +e
          node "$CLI" verify \
            --adapter zokrates-groth16 \
            --verification fixtures/zokrates-groth16/invalid/verification.json \
            --json --use-exit-codes 1>/dev/null
          code=$?; set -e
          if [ "$code" -ne 1 ]; then
            echo "Expected exit 1 (ZoKrates invalid), got $code"; exit 1; fi

  # 3) (opcionális) Artefakt: CLI tarball
  pack-cli:
    needs: [cli-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build CLI
        run: npm -w @zkpip/cli run build

      - name: Pack tarball
        run: npm -w @zkpip/cli pack

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zkpip-cli-tarball
          path: '**/@zkpip/cli-*.tgz'
          if-no-files-found: error
