name: Secret Watchdog

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 3 * * *"  

permissions:
  contents: read
  issues: write

concurrency:
  group: secret-watchdog-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-secret:
    runs-on: ubuntu-latest
    steps:
      # Idempotent
      - name: Open issue if ORG_READ_TOKEN is missing (idempotent)
        if: ${{ env.ORG_READ_TOKEN == '' }}
        env:
          ORG_READ_TOKEN: ${{ secrets.ORG_READ_TOKEN }}   
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const title = "Missing ORG_READ_TOKEN secret";
            const label = "ci:secret-watchdog";

            // ensure label exists
            try {
              await github.rest.issues.getLabel({ owner, repo, name: label });
            } catch {
              await github.rest.issues.createLabel({
                owner, repo, name: label, color: "B60205", description: "Secret watchdog"
              });
            }

            // skip if an open issue with same title+label already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner, repo, state: "open", labels: label, per_page: 100
            });
            if (issues.some(i => i.title === title)) {
              core.info("An open issue already exists. Skipping.");
              return;
            }

            const body = [
              "The `ORG_READ_TOKEN` secret is not set.",
              "",
              "- Workflows depending on it will fail.",
              "- Please set it in repository or organization secrets.",
              "",
              "_Opened by Secret Watchdog._"
            ].join("\n");

            await github.rest.issues.create({ owner, repo, title, body, labels: [label] });